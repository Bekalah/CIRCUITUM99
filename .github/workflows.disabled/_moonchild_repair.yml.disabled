name: _Moonchild Repair (Reusable)

on:
  workflow_call:
    inputs:
      strict:
        required: false
        type: string
        default: "false"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 1, lfs: false }
      - name: Validate required files (no early exit)
        shell: bash
        run: |
          red=0
          need(){ [ -e "$1" ] && echo "✔ $1" || { echo "✘ $1"; red=1; }; }
          need main/registry/04_registry-meta/registry.md
          need main/registry/characters/moonchild/00_README.md
          need main/registry/characters/moonchild/moonchild_profile.md
          need main/registry/characters/moonchild/meta_layers/moonchild_meta_layers.md
          need main/registry/04_registry-meta/system/logs/moonchild/activation-log.md
          need main/registry/04_registry-meta/system/logs/moonchild/dream-log.md
          need main/registry/04_registry-meta/system/logs/moonchild/system-log.md
          need main/registry/04_registry-meta/system/logs/moonchild/grimoire-intake.md
          need scripts/moonchild_invocation.md
          echo "core_failed=$red" >> $GITHUB_OUTPUT
      - name: Strict checks (only if strict=true)
        if: ${{ inputs.strict == 'true' }}
        shell: bash
        run: |
          set -e
          ! grep -RIn "](" --include="*.md" . | grep -E "Moonchild/|00_readme\.md"  # basic link casing guard
      - name: Summary
        if: always()
        run: |
          echo "## Repair summary" >> $GITHUB_STEP_SUMMARY
          echo "strict=${{ inputs.strict }}" >> $GITHUB_STEP_SUMMARY