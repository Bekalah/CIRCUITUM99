      - name: Stage ONLY Moonchild files
        id: stage
        shell: bash
        run: |
          set -euo pipefail
          echo "---- git status (pre-stage) ----"
          git status --porcelain

          # Unstage anything that might already be staged
          git restore --staged :/ || true

          # Whitelist the ONLY paths this bot is allowed to touch
          ALLOW=(
            "main/registry/04_registry-meta/system/logs/moonchild"
            "main/registry/characters/moonchild/meta_layers/grimoires/index.yml"
            "artifacts/sigils"
          )

          for p in "${ALLOW[@]}"; do
            [ -e "$p" ] && git add "$p" || true
          done

          echo "---- git status (post-stage) ----"
          git status --porcelain

          # Safety: if anything outside the whitelist is staged, abort
          if git diff --name-only --cached | grep -Ev '^(main/registry/04_registry-meta/system/logs/moonchild|main/registry/characters/moonchild/meta_layers/grimoires/index.yml|artifacts/sigils)($|/)' ; then
            echo "::error::Detected staged changes outside allowed paths. Aborting commit."
            exit 1
          fi

          # Flag whether we have anything to commit
          if [ -n "$(git diff --cached --name-only)" ]; then
            echo "staged=1" >> $GITHUB_OUTPUT
          else
            echo "staged=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit or PR
        if: steps.stage.outputs.staged == '1'
        id: commit
        shell: bash
        run: |
          git config user.name  "moonchild-bot"
          git config user.email "actions@users.noreply.github.com"
          git commit -m "moonchild: pulse + snapshot + sigil [skip ci]"
          echo "committed=1" >> $GITHUB_OUTPUT

      - name: Push (best case)
        if: steps.commit.outputs.committed == '1'
        continue-on-error: true
        run: git push

      - name: PR fallback (branch protected)
        if: steps.commit.outputs.committed == '1'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/moonchild-pulse-${{ github.run_id }}
          title: "Moonchild: pulse + snapshot + sigil"
          body: "Direct push blocked; auto-PR created."
          commit-message: "moonchild: pulse + snapshot + sigil"